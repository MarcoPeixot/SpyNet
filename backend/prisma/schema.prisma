// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String     @id @default(uuid()) @map("id")
  walletAddress  String     @unique @map("wallet_address") @db.VarChar(255)
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  Apis           Api[]      @relation("CreatorApis")
  Contracts      Contract[] @relation("UserContracts")

  @@map("users") 
}

model Api {
  id             String     @id @default(uuid()) @map("id")
  creatorId      String     @map("creator_id")
  name           String     @map("name") @db.VarChar(255)
  description    String?    @map("description") @db.Text
  endpoint       String     @map("endpoint") @db.VarChar(255)
  pricePerCall   Decimal    @map("price_per_call") @db.Decimal(38, 18) 
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  Creator        User       @relation("CreatorApis", fields: [creatorId], references: [id])
  Contracts      Contract[] @relation("ApiContracts")

  @@map("apis")
}

model Contract {
  id             String     @id @default(uuid()) @map("id")
  apiId          String     @map("api_id")
  userId         String     @map("user_id")
  callsPurchased Int        @map("calls_purchased")
  callsRemaining Int        @map("calls_remaining")
  paymentTxHash  String     @map("payment_tx_hash") @db.VarChar(255)
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  Api            Api        @relation("ApiContracts", fields: [apiId], references: [id])
  User           User       @relation("UserContracts", fields: [userId], references: [id])
  UsageLogs      UsageLog[]

  @@map("contracts")
}

model UsageLog {
  id          String   @id @default(uuid()) @map("id")
  contractId  String   @map("contract_id")
  timestamp   DateTime @default(now()) @map("timestamp") @db.Timestamptz(6)
  callsUsed   Int      @map("calls_used")
  usageHash   String   @map("usage_hash") @db.VarChar(255)

  Contract    Contract @relation(fields: [contractId], references: [id])

  @@map("usage_logs")
}